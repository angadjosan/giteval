name: Deploy to Google App Engine

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'shared/**'
      - '.github/workflows/deploy-app-engine.yml'      
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAE_APPLICATION: ${{ secrets.GAE_APPLICATION }}

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    name: Deploy Frontend
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Next.js
        working-directory: ./frontend
        env:
          # Use custom API subdomain if set, otherwise use backend-dot-project format
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || format('https://backend-dot-{0}.appspot.com/api', secrets.GCP_PROJECT_ID) }}
        run: npm run build

      - name: Prepare standalone deployment
        working-directory: ./frontend
        run: |
          test -d ".next/standalone" || (echo "Error: Standalone build not found!" && exit 1)
          
          mkdir -p deploy
          cp -r .next/standalone/. deploy/
          mkdir -p deploy/.next
          cp -r .next/static deploy/.next/
          cp -r public deploy/
          cp app.yaml deploy/
          
          # Ensure start script matches entrypoint and skip App Engine build
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('deploy/package.json', 'utf8'));
            pkg.scripts = pkg.scripts || {};
            pkg.scripts.start = 'node server.js';
            pkg.scripts['gcp-build'] = ''; // Skip App Engine automatic build
            delete pkg.scripts.build;
            delete pkg.scripts.dev;
            fs.writeFileSync('deploy/package.json', JSON.stringify(pkg, null, 2));
          "
          
          test -f deploy/server.js || (echo "Error: server.js not found!" && exit 1)

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Frontend to App Engine
        working-directory: ./frontend/deploy
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || format('https://backend-dot-{0}.appspot.com/api', secrets.GCP_PROJECT_ID) }}
        run: |
          # Create deploy-specific .gcloudignore
          cat > .gcloudignore << 'EOF'
          .git/
          .gitignore
          *.md
          .env*
          *.log
          .DS_Store
          EOF
          
          # Verify server.js exists
          test -f server.js || (echo "Error: server.js not found!" && exit 1)
          
          # Inject environment variables into app.yaml (remove comment lines and append)
          sed -i '/# NEXT_PUBLIC_API_URL is set during deployment/d' app.yaml
          echo "            NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}" >> app.yaml
          
          # Deploy
          VERSION_NAME="frontend-$(date +%Y%m%d-%H%M%S)"
          gcloud app deploy app.yaml \
            --project=$PROJECT_ID \
            --quiet \
            --version=$VERSION_NAME

  deploy-backend:
    runs-on: ubuntu-latest
    name: Deploy Backend
    needs: deploy-frontend  # Deploy backend after frontend is deployed

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Build TypeScript
        working-directory: ./backend
        run: npm run build

      - name: Verify build output
        working-directory: ./backend
        run: |
          test -f dist/backend/src/index.js || (echo "Error: dist/backend/src/index.js not found!" && exit 1)
          echo "âœ“ Build verified"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Backend to App Engine
        working-directory: ./backend
        env:
          BACKEND_GITHUB_TOKEN: ${{ secrets.BACKEND_GITHUB_TOKEN }}
          BACKEND_CLAUDE_API_KEY: ${{ secrets.BACKEND_CLAUDE_API_KEY }}
          BACKEND_SUPABASE_URL: ${{ secrets.BACKEND_SUPABASE_URL }}
          BACKEND_SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.BACKEND_SUPABASE_SERVICE_ROLE_KEY }}
          BACKEND_REDIS_URL: ${{ secrets.BACKEND_REDIS_URL }}
          BACKEND_FRONTEND_URL: ${{ secrets.BACKEND_FRONTEND_URL || '' }}
          BACKEND_CUSTOM_DOMAIN: ${{ secrets.BACKEND_CUSTOM_DOMAIN || secrets.CUSTOM_DOMAIN || '' }}
          BACKEND_GITHUB_API_URL: ${{ secrets.BACKEND_GITHUB_API_URL || 'https://api.github.com' }}
          BACKEND_CLAUDE_MODEL: ${{ secrets.BACKEND_CLAUDE_MODEL || 'claude-opus-4-5-20251101' }}
          BACKEND_TEMP_DIR: ${{ secrets.BACKEND_TEMP_DIR || '/tmp/giteval' }}
          BACKEND_MAX_REPO_SIZE_MB: ${{ secrets.BACKEND_MAX_REPO_SIZE_MB || '1024' }}
          BACKEND_MAX_REPO_FILES: ${{ secrets.BACKEND_MAX_REPO_FILES || '10000' }}
          BACKEND_ANALYSIS_TIMEOUT_MS: ${{ secrets.BACKEND_ANALYSIS_TIMEOUT_MS || '300000' }}
        run: |
          # Inject environment variables into app.yaml (remove comment lines and append)
          sed -i '/# Environment variables are set via gcloud during deployment/d' app.yaml
          sed -i '/# See .github\/workflows\/deploy-app-engine.yml/d' app.yaml
          
          # Add required environment variables
          echo "            GITHUB_TOKEN: ${BACKEND_GITHUB_TOKEN}" >> app.yaml
          echo "            CLAUDE_API_KEY: ${BACKEND_CLAUDE_API_KEY}" >> app.yaml
          echo "            SUPABASE_URL: ${BACKEND_SUPABASE_URL}" >> app.yaml
          echo "            SUPABASE_SERVICE_ROLE_KEY: ${BACKEND_SUPABASE_SERVICE_ROLE_KEY}" >> app.yaml
          echo "            REDIS_URL: ${BACKEND_REDIS_URL}" >> app.yaml
          
          # Add optional environment variables if they're set
          [ -n "${BACKEND_FRONTEND_URL}" ] && echo "            FRONTEND_URL: ${BACKEND_FRONTEND_URL}" >> app.yaml
          [ -n "${BACKEND_CUSTOM_DOMAIN}" ] && echo "            CUSTOM_DOMAIN: ${BACKEND_CUSTOM_DOMAIN}" >> app.yaml
          [ -n "${BACKEND_GITHUB_API_URL}" ] && echo "            GITHUB_API_URL: ${BACKEND_GITHUB_API_URL}" >> app.yaml
          [ -n "${BACKEND_CLAUDE_MODEL}" ] && echo "            CLAUDE_MODEL: ${BACKEND_CLAUDE_MODEL}" >> app.yaml
          [ -n "${BACKEND_TEMP_DIR}" ] && echo "            TEMP_DIR: ${BACKEND_TEMP_DIR}" >> app.yaml
          [ -n "${BACKEND_MAX_REPO_SIZE_MB}" ] && echo "            MAX_REPO_SIZE_MB: ${BACKEND_MAX_REPO_SIZE_MB}" >> app.yaml
          [ -n "${BACKEND_MAX_REPO_FILES}" ] && echo "            MAX_REPO_FILES: ${BACKEND_MAX_REPO_FILES}" >> app.yaml
          [ -n "${BACKEND_ANALYSIS_TIMEOUT_MS}" ] && echo "            ANALYSIS_TIMEOUT_MS: ${BACKEND_ANALYSIS_TIMEOUT_MS}" >> app.yaml

          # Deploy
          VERSION_NAME="backend-$(date +%Y%m%d-%H%M%S)"
          gcloud app deploy app.yaml \
            --project=$PROJECT_ID \
            --quiet \
            --version=$VERSION_NAME
